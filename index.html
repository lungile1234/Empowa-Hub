<script>
let lastTxnId = null;
let statusInterval = null;

async function processMomoPayment() {
  const recipient = document.getElementById('momoRecipient').value;
  const amount = document.getElementById('momoAmount').value;
  const reference = document.getElementById('momoRef').value;

  if (!recipient || !amount) {
    alert('Please enter recipient and amount');
    return;
  }

  document.getElementById('momoModalContent').innerHTML = `
    <div style="text-align:center">
      <div style="font-size:48px">⏳</div>
      <p>Sending payment request of R${amount} to ${recipient}...</p>
    </div>
  `;

  try {
    const res = await fetch("/api/momoPay", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ phone: recipient, amount, reference })
    });

    const data = await res.json();

    if (res.ok) {
      lastTxnId = data.txnId;

      document.getElementById('momoModalContent').innerHTML = `
        <div style="text-align:center">
          <p>✅ Payment request sent!</p>
          <p><strong>Transaction ID:</strong> ${data.txnId}</p>
          <p>Status: ${data.status}</p>
          <p>Waiting for user to approve on MoMo...</p>
        </div>
      `;

      // Start auto-checking payment status every 5 seconds
      statusInterval = setInterval(() => checkMomoStatus(lastTxnId), 5000);

    } else {
      throw new Error(data.error || "MoMo API error");
    }
  } catch (err) {
    document.getElementById('momoModalContent').innerHTML = `
      <div style="text-align:center; color:var(--danger)">
        <p>❌ Payment failed</p>
        <p>${err.message}</p>
      </div>
    `;
  }
}

async function checkMomoStatus(txnId) {
  try {
    const res = await fetch(`/api/momoStatus?txnId=${txnId}`);
    const data = await res.json();

    if (res.ok) {
      if (data.status && data.status !== "PENDING") {
        clearInterval(statusInterval); // stop checking
        document.getElementById('momoModalContent').innerHTML = `
          <div style="text-align:center">
            <h3>Payment Status</h3>
            <p><strong>Transaction ID:</strong> ${txnId}</p>
            <p><strong>Status:</strong> ${data.status}</p>
            <p><strong>Reason:</strong> ${data.reason || "N/A"}</p>
            <button class="btn" onclick="closeModal('momoModal')">Done</button>
          </div>
        `;
      }
    }
  } catch (err) {
    console.error("Status check error:", err);
  }
}
</script>
